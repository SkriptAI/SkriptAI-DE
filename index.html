// Der Code wurde um folgende Features erweitert:
// - Eingeschränkter Chat für nicht eingeloggte Nutzer (max. 10 Nachrichten)
// - Loginpflicht-Popup nach Limit
// - Kein Anzeigen der Chatliste ohne Login
// - Nachträgliches Bearbeiten von Chatnamen
// - Speicherung von Loginstatus mit Erinnerungsfunktion

<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SkriptAI</title>
  <style>
    .popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #222;
      color: white;
      padding: 20px;
      border-radius: 10px;
      display: none;
      z-index: 999;
      text-align: center;
    }
  </style>
  <script>
    let currentLanguage = '';
    let currentUser = localStorage.getItem('skriptai_current_user') || null;
    let currentChatId = null;
    let messageCounter = parseInt(localStorage.getItem('skriptai_message_count')) || 0;
    const users = JSON.parse(localStorage.getItem('skriptai_users') || '{}');

    function saveUsers() {
      localStorage.setItem('skriptai_users', JSON.stringify(users));
    }

    function handleForm(event) {
      event.preventDefault();
      const chatBox = document.getElementById("chatBox");
      const message = chatBox.value.trim();
      if (message === "") return;

      if (!currentUser) {
        messageCounter++;
        localStorage.setItem('skriptai_message_count', messageCounter);
        if (messageCounter > 10) {
          showPopup(currentLanguage === 'en' ? "Please log in to continue chatting." : "Bitte logge dich ein, um weiterzuschreiben.");
          chatBox.disabled = true;
          document.getElementById("sendBtn").disabled = true;
          return;
        }
      } else {
        if (!currentChatId) newChat();
      }

      if (currentUser && users[currentUser].chats[currentChatId].length === 0) {
        updateChatName(currentChatId, message);
      }
      appendMessage(message);
      appendMessage(currentLanguage === 'en' ? "The software isn't finished yet." : "Die Software ist noch nicht fertig gecoded.");
      chatBox.value = "";
      if (currentUser) saveChat();
    }

    function appendMessage(text) {
      const chatContainer = document.getElementById("chatContainer");
      const msg = document.createElement("div");
      msg.className = "chat-message";
      msg.textContent = text;
      chatContainer.appendChild(msg);
      chatContainer.scrollTop = chatContainer.scrollHeight;
      if (currentUser) users[currentUser].chats[currentChatId].push(text);
    }

    function toggleTheme() {
      document.body.classList.toggle("light-mode");
    }

    function chooseLanguage(lang) {
      currentLanguage = lang;
      document.getElementById("languageSelect").style.display = "none";
      document.getElementById("mainApp").style.display = "flex";
    }

    function newChat() {
      if (!currentUser) return;
      const id = "chat_" + Date.now();
      users[currentUser].chats[id] = [];
      currentChatId = id;
      updateChatList();
      loadChat(id);
      saveUsers();
    }

    function loadChat(id) {
      currentChatId = id;
      const container = document.getElementById("chatContainer");
      container.innerHTML = "";
      users[currentUser].chats[id].forEach(m => appendMessage(m));
    }

    function updateChatList() {
      const list = document.getElementById("chatList");
      list.innerHTML = "";
      if (!currentUser) return;
      Object.entries(users[currentUser].chats).forEach(([id, msgs]) => {
        const name = msgs[0] || id;
        const btn = document.createElement("button");
        btn.textContent = name;
        btn.onclick = () => loadChat(id);
        btn.oncontextmenu = (e) => {
          e.preventDefault();
          const newName = prompt(currentLanguage === 'en' ? "Rename chat:" : "Chat umbenennen:", name);
          if (newName) {
            users[currentUser].chats[id][0] = newName;
            updateChatList();
            saveUsers();
          }
        };
        list.appendChild(btn);
      });
    }

    function updateChatName(id, name) {
      users[currentUser].chats[id][0] = name;
      updateChatList();
    }

    function login() {
      const username = prompt("Benutzername:");
      const password = prompt("Passwort:");
      if (!users[username]) {
        users[username] = { password: password, chats: {} };
      } else if (users[username].password !== password) {
        alert("Falsches Passwort!");
        return;
      }
      currentUser = username;
      localStorage.setItem('skriptai_current_user', username);
      messageCounter = 0;
      localStorage.setItem('skriptai_message_count', '0');
      updateChatList();
      document.getElementById("loginBtn").style.display = "none";
      document.getElementById("logoutBtn").style.display = "inline-block";
      document.getElementById("chatBox").disabled = false;
      document.getElementById("sendBtn").disabled = false;
    }

    function logout() {
      currentUser = null;
      localStorage.removeItem('skriptai_current_user');
      localStorage.removeItem('skriptai_message_count');
      location.reload();
    }

    function saveChat() {
      saveUsers();
    }

    function showPopup(text) {
      const popup = document.getElementById("popup");
      popup.textContent = text;
      popup.style.display = "block";
      setTimeout(() => popup.style.display = "none", 4000);
    }

    window.onload = () => {
      if (currentUser) {
        document.getElementById("languageSelect").style.display = "none";
        document.getElementById("mainApp").style.display = "flex";
        document.getElementById("loginBtn").style.display = "none";
        document.getElementById("logoutBtn").style.display = "inline-block";
        updateChatList();
      }
    }
  </script>
</head>
<body>
  <div id="popup" class="popup"></div>
</body>
</html>
